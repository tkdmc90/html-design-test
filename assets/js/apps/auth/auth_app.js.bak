define(["app"], function (BrewOptix) {
    BrewOptix.module("AuthApp", function (AuthApp, BrewOptix, Backbone, Marionette, $, _) {

        AuthApp.Router = Marionette.AppRouter.extend({
            appRoutes: {
                "login": "login"
            }
        });

        var api = {
            login: function (route) {
                require(["apps/auth/login/login_controller"], function (LoginController) {
                    LoginController.showLogin(route);
                });
            }
        };

        AuthApp.GetLoginHash = function () {
            if (AuthApp.LoginHash === undefined) {
                AuthApp.LoginHash = $.cookie('auth');
            }
            return AuthApp.LoginHash;
        };

        BrewOptix.on("auth:login", function (route) {
            BrewOptix.navigate("login");
            api.login(route);
        });

        BrewOptix.on("auth:logout", function () {
            $.removeCookie('auth');
            BrewOptix.resetWindow();
            BrewOptix.navigate("login", { trigger: true });
        });

        BrewOptix.addInitializer(function () {
            new AuthApp.Router({
                controller: api
            });

            $.ajaxSetup({
                statusCode: {
                    401: function() {
                        BrewOptix.trigger("auth:login");
                    }
                }
            });
        });
    });

    return BrewOptix.AuthApp;
});